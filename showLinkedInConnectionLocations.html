<html>
<head>
<style>
	html, body, #map-canvas {
		height: 100%;
		margin: 0px;
		padding: 0px
	}
</style>
<script>
/*
First LinkedIn api key that hit the throttle limit.
Can only hit the Company profile ~50 times before being restricted.
Will reset at midnight of each day.
api_key:77evzvvs49kyz3
*/
</script>
<script type="text/javascript" src="http://platform.linkedin.com/in.js">
	api_key:77v3t4fga0sld0
	onLoad: onLinkedInLoad
	scope: r_basicprofile r_network
	authorize: true
</script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script>
	var geocoder;
	var map;
	function initialize() {
		geocoder = new google.maps.Geocoder();
		var latlng = new google.maps.LatLng(42.3581, -71.0636);
		var mapOptions = {
			zoom: 8,
			center: latlng
		}
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	}

	function codeAddress(address) {
		geocoder.geocode( { 'address': address}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				map.setCenter(results[0].geometry.location);
				var marker = new google.maps.Marker({
					map: map,
					position: results[0].geometry.location
				});
			} else {
				alert('Geocode was not successful for the following reason: ' + status);
			}
		});
}

google.maps.event.addDomListener(window, 'load', initialize);	
</script>

<script type="text/javascript">
	function onLinkedInLoad() {
		IN.Event.on(IN, "auth", onLinkedInAuth);
	}

	function onLinkedInAuth() {
		IN.API.Profile("me").result(displayProfiles);
		IN.API.Connections("me")
			.fields("positions:(company)")
			.result(searchForCompanyByConnection)
			.error(displayConnectionErrors);
	}

	function displayProfiles(profiles) {
		var profilesDiv = document.getElementById("profiles");
		member = profiles.values[0];
		profilesDiv.innerHTML = "<p id=\"" + member.id + "\">Hello " + member.firstName + ", the company locations of your LinkedIn connections are mapped below:</p>";
		
		document.getElementById("loginMessage").innerHTML = "";
	}

	function searchForCompanyByConnection(connections) {
		var companyIDs = [];
		var members = connections.values;
		for (var member in members) {
			var count = members[member].positions._total;
			if (count > 0) {
				companyIDs[companyIDs.length] = members[member].positions.values[0].company.id;
			} 
		}     
		searchForCompanyLocations(companyIDs);
	}

	function searchForCompanyLocations(companyIDs) {
		var companyIDString = companyIDs.toString();
		var searchString = "companies::(" + companyIDString + "):(locations:(address:(street1,city,state)))";
		
		IN.API.Raw(searchString).result(displayCompanyLocations);
	}

	function displayCompanyLocations(companyLocations) {
		for (var companyLocation in companyLocations.values) {
			var locationValues = companyLocations.values[companyLocation].locations;
			if (locationValues._total < 1) {
				continue;
			}

			var address = locationValues.values[0].address;
			var fullAddress = address.street1 + " " + address.city + " " + address.state;
			
			codeAddress(fullAddress);
		}
	}

	function displayConnectionErrors(error) {
		var connectionsDiv = document.getElementById("connections");
	}
</script>

</head>
<body>
<div id="loginMessage">Please click on the LinkedIn button below to log in:</div>
<script type="in/Login">
</script>

<div id="profiles"></div>
<div id="map-canvas"></div>
</body>
</html>
